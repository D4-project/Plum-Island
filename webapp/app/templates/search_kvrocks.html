{% extends "appbuilder/base.html" %}
{% import 'appbuilder/general/lib.html' as lib %}

{% block content %}
{{ lib.panel_begin(title, "Query Scans") }}

<script>
function formatTimestamp(ts) {
    if (ts === null || ts === undefined) {
        return '';
    }
    const numericTs = Number(ts);
    if (Number.isNaN(numericTs)) {
        return '';
    }
    const milliseconds = numericTs > 1e12 ? numericTs : numericTs * 1000;
    const date = new Date(milliseconds);
    return Number.isNaN(date.getTime()) ? '' : date.toLocaleDateString();
}

function formatTimestampWithRaw(ts) {
    if (ts === null || ts === undefined || ts === '') {
        return '';
    }
    const pretty = formatTimestamp(ts);
    return pretty || ts;
}

function hasTimestampValue(value) {
    return value !== null && value !== undefined && value !== '';
}

function buildTimestampMeta(first, last) {
    if (!hasTimestampValue(first) && !hasTimestampValue(last)) {
        return '';
    }
    const firstDisplay = hasTimestampValue(first) ? formatTimestampWithRaw(first) : 'N/A';
    const lastDisplay = hasTimestampValue(last) ? formatTimestampWithRaw(last) : 'N/A';
    return `<span class="timestamp-meta">
        <span class="timestamp-chip timestamp-first">
            <i class="fa-solid fa-backward-step" aria-hidden="true"></i>
            ${firstDisplay}
        </span>
        <span class="timestamp-separator">|</span>
        <span class="timestamp-chip timestamp-last">
            ${lastDisplay}
            <i class="fa-solid fa-forward-step" aria-hidden="true"></i>
        </span>
    </span>`;
}

async function search() {
    const query = document.getElementById('query').value;
    const res = await fetch(`/kvsearchview/query?q=${encodeURIComponent(query)}`);
    const data = await res.json();

    const hitsDiv = document.getElementById('hits');
    const infoDiv = document.getElementById('info');
    const errorDiv = document.getElementById('msg_error');
    const time = (data.processingTimeMs || 0).toFixed(3);
    infoDiv.innerHTML = `Found ${Object.keys(data.results).length} Results in ${time}ms out of ${data.uid_count} scans on ${data.ip_count} hosts`;

    errorDiv.innerHTML = ``;
    if (data.status === false) {
    errorDiv.innerHTML = `<div class="alert alert-warning" role="alert">${data.msg_error}</div>`;
    }
    hitsDiv.innerHTML = '';

    Object.entries(data.results).forEach(([ip, uids], ipIndex) => {
        const ipPanel = document.createElement('div');
        ipPanel.className = 'panel panel-default';
        const ipTimestamps = data.timestamps && data.timestamps[ip] ? data.timestamps[ip] : {};
        const ipLabel = ip;
        const ipMeta = buildTimestampMeta(ipTimestamps.min_seen, ipTimestamps.max_seen);

        // IP accordion
        ipPanel.innerHTML = `
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a data-toggle="collapse" data-parent="#hits" href="#collapse-ip-${ipIndex}">
                        ${ipLabel}
                        ${ipMeta}
                    </a>
                </h4>
            </div>
            <div id="collapse-ip-${ipIndex}" class="panel-collapse collapse">
                <div class="panel-body" id="uids-${ipIndex}">
                    <!-- UID panels will go here -->
                </div>
            </div>
        `;
        hitsDiv.appendChild(ipPanel);

        const uidsDiv = document.getElementById(`uids-${ipIndex}`);
        const sortedUids = [...uids].sort((a, b) => {
            const aLast = ipTimestamps[a] && ipTimestamps[a].last_seen ? Number(ipTimestamps[a].last_seen) : -Infinity;
            const bLast = ipTimestamps[b] && ipTimestamps[b].last_seen ? Number(ipTimestamps[b].last_seen) : -Infinity;
            return bLast - aLast;
        });

        sortedUids.forEach((uid, uidIndex) => {
            const uidPanel = document.createElement('div');
            uidPanel.className = 'panel panel-info';
            const uidTimestamp = ipTimestamps && ipTimestamps[uid] ? ipTimestamps[uid] : null;
            const uidLabel = uid;
            const uidMeta = uidTimestamp
                ? buildTimestampMeta(uidTimestamp.first_seen, uidTimestamp.last_seen)
                : '';
            uidPanel.innerHTML = `
                <div class="panel-heading">
                    <h5 class="panel-title">
                        <a href="#" onclick="loadUid('${uid}', 'uid-body-${ipIndex}-${uidIndex}'); return false;">
                            ${uidLabel}
                        </a>
                        ${uidMeta}
                    </h5>
                </div>
                <div id="uid-body-${ipIndex}-${uidIndex}" class="panel-body" style="display:none;"></div>
            `;
            uidsDiv.appendChild(uidPanel);
        });
    });
}

async function loadUid(uid, targetId) {
    const target = document.getElementById(targetId);
    if (target.style.display === 'none' || target.innerHTML === '') {
        const res = await fetch(`/meilisearchview/getuid?uid=${uid}`);
        const data = await res.json();
        let json = JSON.stringify(data, null, 2);
        // garde l'indentation devant les lignes ajoutÃ©es
        json = json.replace(/^( *)(.*"output": ".*)$/gm, (match, indent, line) =>
            line.replace(/\\n/g, '\\n\n' + indent + '  ')
        );
        target.innerHTML = `<pre>${json}</pre>`;
        target.style.display = 'block';
    } else {
        target.style.display = 'none';
    }
}

</script>
<style>
.timestamp-meta {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    margin-left: auto;
    font-size: 0.85em;
    font-family: "Arial Narrow", "Roboto Condensed", "Helvetica Neue", Arial, sans-serif;
    color: #6c757d;
    float: right;
    text-align: right;
}
.timestamp-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    white-space: nowrap;
}
.timestamp-separator {
    font-weight: 600;
}
.timestamp-chip i {
    font-size: 0.9em;
}
</style>

<div class="container mt-2">
    <div class="row g-2">
        <div class="col-12 col-md-10">
            <input type="text" id="query" class="form-control" placeholder="Query...">
        </div>
        <div class="col-12 col-md-2">
            <button class="btn btn-primary w-100" onclick="search()">Search</button>
        </div>
    </div>
</div>

<div id="info" class="mt-2"></div>
<div id="msg_error" class="panel-group mt-2"></div>
<div id="hits" class="panel-group mt-2"></div>
{{ lib.panel_end() }}
{% endblock content %}

{% block add_tail_js %}
<script src="{{url_for('appbuilder.static',filename='js/ab_keep_tab.js')}}" nonce="{{ baselib.get_nonce() }}"></script>
{% endblock %}
