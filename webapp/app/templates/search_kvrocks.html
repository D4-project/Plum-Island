{% extends "appbuilder/base.html" %}
{% import 'appbuilder/general/lib.html' as lib %}

{% block content %}
{{ lib.panel_begin(title, "Query Scans") }}

<script>
let lastSuccessfulQuery = null;

function formatTimestamp(ts) {
    if (ts === null || ts === undefined) {
        return '';
    }
    const numericTs = Number(ts);
    if (Number.isNaN(numericTs)) {
        return '';
    }
    const milliseconds = numericTs > 1e12 ? numericTs : numericTs * 1000;
    const date = new Date(milliseconds);
    return Number.isNaN(date.getTime()) ? '' : date.toLocaleDateString();
}

function formatTimestampWithRaw(ts) {
    if (ts === null || ts === undefined || ts === '') {
        return '';
    }
    const pretty = formatTimestamp(ts);
    return pretty || ts;
}

function hasTimestampValue(value) {
    return value !== null && value !== undefined && value !== '';
}

function buildTimestampMeta(first, last) {
    if (!hasTimestampValue(first) && !hasTimestampValue(last)) {
        return '';
    }
    const firstDisplay = hasTimestampValue(first) ? formatTimestampWithRaw(first) : 'N/A';
    const lastDisplay = hasTimestampValue(last) ? formatTimestampWithRaw(last) : 'N/A';
    return `<span class="timestamp-meta">
        <span class="timestamp-chip timestamp-first">
            <i class="fa-solid fa-backward-step" aria-hidden="true"></i>
            ${firstDisplay}
        </span>
        <span class="timestamp-separator">|</span>
        <span class="timestamp-chip timestamp-last">
            ${lastDisplay}
            <i class="fa-solid fa-forward-step" aria-hidden="true"></i>
        </span>
    </span>`;
}

function copyIpToClipboard(ip, triggerEl) {
    const markCopied = () => {
        if (!triggerEl) {
            return;
        }
        triggerEl.classList.add('copied');
        triggerEl.setAttribute('aria-label', `Copied ${ip}`);
        setTimeout(() => {
            triggerEl.classList.remove('copied');
            triggerEl.removeAttribute('aria-label');
        }, 1500);
    };

    const fallbackCopy = () => {
        const textarea = document.createElement('textarea');
        textarea.value = ip;
        textarea.setAttribute('readonly', '');
        textarea.style.position = 'absolute';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            markCopied();
        } catch (err) {
            console.warn('Clipboard copy failed', err);
        } finally {
            document.body.removeChild(textarea);
        }
    };

    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(ip).then(markCopied).catch(fallbackCopy);
    } else {
        fallbackCopy();
    }
}

function setDownloadButtonState(enabled) {
    const container = document.getElementById('download-button-container');
    if (!container) {
        return;
    }
    container.innerHTML = '';
    if (!enabled) {
        return;
    }
    const button = document.createElement('button');
    button.type = 'button';
    button.id = 'download-ips-btn';
    button.className = 'btn btn-outline-secondary w-100 mt-2';
    button.textContent = 'Download';
    button.addEventListener('click', downloadIps);
    container.innerHTML = '<br>';
    container.appendChild(button);
}

function setSearchLoading(isLoading) {
    const spinner = document.getElementById('info-spinner');
    const searchBtn = document.getElementById('search-btn');
    if (!spinner || !searchBtn) {
        return;
    }
    if (isLoading) {
        spinner.style.display = 'inline-flex';
        searchBtn.disabled = true;
    } else {
        spinner.style.display = 'none';
        searchBtn.disabled = false;
    }
}

function downloadIps() {
    if (!lastSuccessfulQuery) {
        return;
    }
    const url = `/kvsearchview/export?q=${encodeURIComponent(lastSuccessfulQuery)}`;
    const tmpLink = document.createElement('a');
    tmpLink.href = url;
    tmpLink.style.display = 'none';
    tmpLink.setAttribute('download', 'ip_list.txt');
    document.body.appendChild(tmpLink);
    tmpLink.click();
    document.body.removeChild(tmpLink);
}

async function search() {
    const query = document.getElementById('query').value;
    lastSuccessfulQuery = null;
    setDownloadButtonState(false);
    const hitsDiv = document.getElementById('hits');
    const infoDiv = document.getElementById('info');
    const errorDiv = document.getElementById('msg_error');
    setSearchLoading(true);
    try {
        const res = await fetch(`/kvsearchview/query?q=${encodeURIComponent(query)}`);
        const data = await res.json();

        const time = (data.processingTimeMs || 0).toFixed(3);
        infoDiv.innerHTML = `Found ${Object.keys(data.results).length} Results in ${time}ms out of ${data.uid_count} scans on ${data.ip_count} hosts`;

        errorDiv.innerHTML = ``;
        if (data.status === false) {
            errorDiv.innerHTML = `<div class="alert alert-warning" role="alert">${data.msg_error}</div>`;
        }
        if (data.status && Object.keys(data.results || {}).length > 0) {
            lastSuccessfulQuery = query;
            setDownloadButtonState(true);
        }

        hitsDiv.innerHTML = '';

        Object.entries(data.results).forEach(([ip, uids], ipIndex) => {
            const ipPanel = document.createElement('div');
            ipPanel.className = 'panel panel-default';
            const ipTimestamps = data.timestamps && data.timestamps[ip] ? data.timestamps[ip] : {};
            const ipLabel = ip;
            const ipMeta = buildTimestampMeta(ipTimestamps.min_seen, ipTimestamps.max_seen);

            // IP accordion
            ipPanel.innerHTML = `
                <div class="panel-heading">
                    <h4 class="panel-title">
                        <a data-toggle="collapse" data-parent="#hits" href="#collapse-ip-${ipIndex}">
                            ${ipLabel}
                        </a>
                        <button type="button" class="ip-quick-link" onclick="copyIpToClipboard('${ipLabel}', this)" title="Copy ${ipLabel}">
                            <i class="fa-regular fa-copy" aria-hidden="true"></i>
                        </button>
                        ${ipMeta}
                    </h4>
                </div>
                <div id="collapse-ip-${ipIndex}" class="panel-collapse collapse">
                    <div class="panel-body" id="uids-${ipIndex}">
                        <!-- UID panels will go here -->
                    </div>
                </div>
            `;
            hitsDiv.appendChild(ipPanel);

            const uidsDiv = document.getElementById(`uids-${ipIndex}`);
            const sortedUids = [...uids].sort((a, b) => {
                const aLast = ipTimestamps[a] && ipTimestamps[a].last_seen ? Number(ipTimestamps[a].last_seen) : -Infinity;
                const bLast = ipTimestamps[b] && ipTimestamps[b].last_seen ? Number(ipTimestamps[b].last_seen) : -Infinity;
                return bLast - aLast;
            });

            sortedUids.forEach((uid, uidIndex) => {
                const uidPanel = document.createElement('div');
                uidPanel.className = 'panel panel-info';
                const uidTimestamp = ipTimestamps && ipTimestamps[uid] ? ipTimestamps[uid] : null;
                const uidLabel = uid;
                const uidMeta = uidTimestamp
                    ? buildTimestampMeta(uidTimestamp.first_seen, uidTimestamp.last_seen)
                    : '';
                uidPanel.innerHTML = `
                    <div class="panel-heading">
                        <h5 class="panel-title">
                            <a href="#" onclick="loadUid('${uid}', 'uid-body-${ipIndex}-${uidIndex}'); return false;">
                                ${uidLabel}
                            </a>
                            ${uidMeta}
                        </h5>
                    </div>
                    <div id="uid-body-${ipIndex}-${uidIndex}" class="panel-body" style="display:none;"></div>
                `;
                uidsDiv.appendChild(uidPanel);
            });
        });
    } catch (error) {
        console.error('KV search failed', error);
        errorDiv.innerHTML = `<div class="alert alert-danger" role="alert">Search failed: ${error?.message || 'Unexpected error'}</div>`;
        infoDiv.innerHTML = '';
        hitsDiv.innerHTML = '';
    } finally {
        setSearchLoading(false);
    }
}

async function loadUid(uid, targetId) {
    const target = document.getElementById(targetId);
    if (target.style.display === 'none' || target.innerHTML === '') {
        const res = await fetch(`/meilisearchview/getuid?uid=${uid}`);
        const data = await res.json();
        let json = JSON.stringify(data, null, 2);
        // garde l'indentation devant les lignes ajoutÃ©es
        json = json.replace(/^( *)(.*"output": ".*)$/gm, (match, indent, line) =>
            line.replace(/\\n/g, '\\n\n' + indent + '  ')
        );
        target.innerHTML = `<pre>${json}</pre>`;
        target.style.display = 'block';
    } else {
        target.style.display = 'none';
    }
}

</script>
<style>
.timestamp-meta {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    margin-left: auto;
    font-size: 0.85em;
    font-family: "Arial Narrow", "Roboto Condensed", "Helvetica Neue", Arial, sans-serif;
    color: #6c757d;
    float: right;
    text-align: right;
}
.timestamp-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    white-space: nowrap;
}
.timestamp-separator {
    font-weight: 600;
}
.timestamp-chip i {
    font-size: 0.9em;
}
.ip-quick-link {
    margin-left: 0.6rem;
    color: #337ab7;
    font-size: 1rem;
    border: none;
    background: transparent;
    padding: 0;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
}
.ip-quick-link:hover,
.ip-quick-link:focus {
    color: #23527c;
    text-decoration: none;
    outline: none;
}
.ip-quick-link.copied {
    color: #3c763d;
}
.kvrocks-table-wrapper {
    display: flex;
    justify-content: center;
    margin: 2rem auto 1.5rem;
    padding: 0 1.25rem;
}
.kvrocks-table {
    border-collapse: collapse;
    font-family: "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif;
    font-size: 0.88rem;
    min-width: 420px;
    max-width: 940px;
    width: 100%;
    text-align: left;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    border: 1px solid rgba(51, 122, 183, 0.25);
}
.kvrocks-table th {
    padding: 0.35rem 0.8rem;
}
.kvrocks-table td {
    padding: 0.6rem 0.85rem;
}
.kvrocks-table thead {
    background: #337ab7;
    color: #fff;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    font-weight: 600;
    border-bottom: 2px solid #265a88;
}
.kvrocks-table th,
.kvrocks-table td {
    text-align: left;
}
.kvrocks-table th:nth-child(4),
.kvrocks-table td:nth-child(4) {
    border-left: 2px solid rgba(51, 122, 183, 0.25);
}
.kvrocks-table td:nth-child(n+4) {
    padding-left: 1.1rem;
}
.kvrocks-table tbody tr:nth-child(even) {
    background: #f5f8fb;
}
.kvrocks-table tbody tr:nth-child(odd) {
    background: #ffffff;
}
.kvrocks-table tbody tr:hover {
    background: rgba(51, 122, 183, 0.11);
}
.kvrocks-table td:first-child,
.kvrocks-table td:nth-child(4) {
    font-weight: 600;
    color: #24527a;
}
.kvrocks-table td:nth-child(2),
.kvrocks-table td:nth-child(5) {
    color: #4d6172;
}
.kvrocks-table td:nth-child(3),
.kvrocks-table td:nth-child(6) {
    color: #2f353a;
}
.kvrocks-table td.kvrocks-empty {
    padding: 0;
    border: none;
    color: transparent;
}
</style>

<div class="container mt-2">
    <div class="row g-2">
        <div class="col-12 col-md-10">
            <input type="text" id="query" class="form-control" placeholder="Query...">
        </div>
        <div class="col-12 col-md-2 d-flex flex-column align-items-stretch">
            <button type="button" id="search-btn" class="btn btn-primary w-100" onclick="search()">Search</button>
            <div id="download-button-container" class="mt-2 w-100"></div>
        </div>
    </div>
</div>

<div id="info" class="mt-2"></div>
<div id="info-spinner" class="text-muted mt-1" role="status" aria-live="polite" style="display:none;">
    <i class="fa fa-spinner fa-spin" aria-hidden="true"></i>
    <span style="margin-left:0.35rem;">Searching...</span>
</div>
<div id="msg_error" class="panel-group mt-2"></div>
<div id="hits" class="panel-group mt-2"></div>
{{ lib.panel_end() }}

<div class="kvrocks-table-wrapper">
    <table class="kvrocks-table">
        <thead>
            <tr>
                <th>Keyword</th>
                <th>Modifier</th>
                <th>Description</th>
                <th>Keyword</th>
                <th>Modifier</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>ip</td>
                <td></td>
                <td>IP of the host</td>
                <td>http_title</td>
                <td>lk, bg</td>
                <td>HTML title tag</td>
            </tr>
            <tr>
                <td>net</td>
                <td></td>
                <td>CIDR network, from /16 to /24</td>
                <td>http_cookiename</td>
                <td>lk, bg</td>
                <td>HTTP Set-Cookie key name</td>
            </tr>
            <tr>
                <td>fqdn</td>
                <td>lk, bg</td>
                <td>Fully qualified domain name</td>
                <td>http_etag</td>
                <td>lk, bg</td>
                <td>HTTP ETag value</td>
            </tr>
            <tr>
                <td>host</td>
                <td>lk, bg</td>
                <td>Hostname, the subdomain part</td>
                <td>http_server</td>
                <td>lk, bg</td>
                <td>HTTP server header</td>
            </tr>
            <tr>
                <td>domain</td>
                <td>lk, bg</td>
                <td>DNS domain</td>
                <td>x509_issuer</td>
                <td>lk, bg</td>
                <td>TLS certificate issuer</td>
            </tr>
            <tr>
                <td>tld</td>
                <td>lk, bg</td>
                <td>Top level domain</td>
                <td>x509_subject</td>
                <td>lk, bg</td>
                <td>TLS certificate common name</td>
            </tr>
            <tr>
                <td>port</td>
                <td></td>
                <td>Open port</td>
                <td>x509_san</td>
                <td>lk, bg</td>
                <td>TLS certificate subject alternative names</td>
            </tr>
            <tr>
                <td>banner</td>
                <td>lk, bg</td>
                <td>Service banner value</td>
                <td>x509_md5</td>
                <td></td>
                <td>MD5 of the TLS certificate public signature</td>
            </tr>
            <tr>
                <td class="kvrocks-empty" aria-hidden="true"></td>
                <td class="kvrocks-empty" aria-hidden="true"></td>
                <td class="kvrocks-empty" aria-hidden="true"></td>
                <td>x509_sha1</td>
                <td></td>
                <td>SHA1 of the TLS certificate public signature</td>
            </tr>
            <tr>
                <td class="kvrocks-empty" aria-hidden="true"></td>
                <td class="kvrocks-empty" aria-hidden="true"></td>
                <td class="kvrocks-empty" aria-hidden="true"></td>
                <td>x509_sha256</td>
                <td></td>
                <td>SHA256 of the TLS certificate public signature</td>
            </tr>
        </tbody>
    </table>
</div>

{% endblock content %}

{% block add_tail_js %}
<script src="{{url_for('appbuilder.static',filename='js/ab_keep_tab.js')}}" nonce="{{ baselib.get_nonce() }}"></script>
{% endblock %}
